# trigger:
# - main
# pool: Default
# #---------------------- BACKEND BUILD ----------------------  
# stages:
# - stage: Build
#   displayName: "Build Backend"
#   jobs:
#   - job: Build_Backend
#     pool:
#       vmImage: 'ubuntu-latest'
#     steps:
#     - task: Bash@3
#       inputs:
#         targetType: 'inline'
#         script: |
#           sudo apt update
#           sudo apt install -y python3 python3-pip
#       displayName: "Install Python"
trigger:
- main

pool: Default

stages:
#---------------------- BACKEND BUILD ----------------------
- stage: Build
  displayName: "Build Backend"
  jobs:
  - job: Build_Backend
    steps:

    # Install Python silently
    - task: PowerShell@2
      displayName: Install Python
      inputs:
        targetType: inline
        script: |
          Invoke-WebRequest -Uri https://www.python.org/ftp/python/3.10.11/python-3.10.11-amd64.exe -OutFile python.exe
          Start-Process python.exe -ArgumentList "/quiet InstallAllUsers=1 PrependPath=1" -Wait

    # Check versions
    - script: |
        python --version
        pip --version
      displayName: Verify Python

    # Install dependencies into package folder
    - script: |
        pip install -r PyTodoBackendMonolith/requirements.txt -t package
      displayName: Install Requirements

    # Publish artifact
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: 'PyTodoBackendMonolith'
        ArtifactName: 'backend_artifact'

#---------------------- BACKEND DEPLOY ----------------------
- stage: Deploy
  displayName: "Deploy Backend"
  dependsOn: Build
  jobs:
  - job: Deploy_Backend
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'backend_artifact'
        downloadPath: '$(Pipeline.Workspace)/backend'
      displayName: "Download Backend Artifact"    
    - task: CopyFilesOverSSH@0
      inputs:
        sshEndpoint: 'backend-ssh'
        sourceFolder: '$(Pipeline.Workspace)/backend'
        contents: '**'
        targetFolder: '/var/app/backend'
        readyTimeout: '20000'
      displayName: "Copy Backend Files to VM"
    - task: SSH@0
      inputs:
        sshEndpoint: 'backend-ssh'
        runOptions: 'inline'
        inline: |
          cd /var/app/backend/backend_artifact/PyTodoBackendMonolith 
          pip3 install -r requirements.txt
          pkill -f uvicorn || true
          nohup uvicorn app:app --host 0.0.0.0 --port 8000 &
        readyTimeout: '20000'
      displayName: "Install Dependencies & Restart Uvicorn"