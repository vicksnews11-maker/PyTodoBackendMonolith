trigger:
- main

pool:
  name: 'Default'   # Windows self-hosted agent

stages:

# ============================================================
#                     BACKEND BUILD (WINDOWS)
# ============================================================
- stage: Build
  displayName: "Build Backend"
  jobs:
  - job: Build_Backend
    displayName: "Build Backend on Windows Agent"
    steps:

    # ---------------------------------------------------------
    # Install Python only if not already installed
    # ---------------------------------------------------------
    - task: PowerShell@2
      displayName: "Install Python Only If Missing"
      inputs:
        targetType: inline
        script: |
          # Check if python exists
          if (Get-Command python -ErrorAction SilentlyContinue) {
              Write-Host "Python is already installed."
              python --version
              exit 0
          }

          Write-Host "Python not found. Installing now..."

          # Download installer
          $pythonInstaller = "python-installer.exe"
          Invoke-WebRequest -Uri "https://www.python.org/ftp/python/3.12.0/python-3.12.0-amd64.exe" -OutFile $pythonInstaller

          # Install silently
          Start-Process ".\python-installer.exe" -ArgumentList "/quiet InstallAllUsers=1 PrependPath=1" -Wait

          # Manually add Python to PATH for this pipeline step
          $pythonPath = "C:\Program Files\Python312\"
          $scriptsPath = "C:\Program Files\Python312\Scripts\"

          if (Test-Path $pythonPath) {
              Write-Host "Python found at $pythonPath"
              $env:Path = "$pythonPath;$scriptsPath;" + $env:Path
          } else {
              Write-Host "Python installation folder not found!"
              Get-ChildItem "C:\Program Files"
          }

          # Use full path to ensure it works
          & "C:\Program Files\Python312\python.exe" --version


    # ---------------------------------------------------------
    # Install backend dependencies
    # ---------------------------------------------------------
    - task: PowerShell@2
      displayName: "Install Backend Dependencies"
      inputs:
        targetType: inline
        script: |
          cd PyTodoBackendMonolith
          "C:\Program Files\Python312\python.exe" -m pip install -r requirements.txt --target "./package"


    # ---------------------------------------------------------
    # Publish artifacts
    # ---------------------------------------------------------
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: 'PyTodoBackendMonolith'
        ArtifactName: 'backend_artifact'
        publishLocation: 'Container'


# ============================================================
#                     BACKEND DEPLOY (LINUX VM)
# ============================================================
- stage: Deploy
  displayName: "Deploy Backend"
  dependsOn: Build
  jobs:
  - job: Deploy_Backend
    displayName: "Deploy Backend to Linux VM"
    steps:

    - task: DownloadBuildArtifacts@1
      inputs:
        artifactName: 'backend_artifact'
        downloadPath: '$(Pipeline.Workspace)/backend'

    - task: CopyFilesOverSSH@0
      displayName: "Copy Backend Files"
      inputs:
        sshEndpoint: 'backend-ssh'
        sourceFolder: '$(Pipeline.Workspace)/backend'
        targetFolder: '/var/app/backend'
        overwrite: true

    - task: SSH@0
      displayName: "Restart Backend"
      inputs:
        sshEndpoint: 'backend-ssh'
        runOptions: inline
        inline: |
          cd /var/app/backend
          pip3 install -r requirements.txt
          pkill -f uvicorn || true
          nohup uvicorn app:app --host 0.0.0.0 --port 8000 &
