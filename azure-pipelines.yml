# trigger:
# - main
# pool: Default
# #---------------------- BACKEND BUILD ----------------------  
# stages:
# - stage: Build
#   displayName: "Build Backend"
#   jobs:
#   - job: Build_Backend
#     pool:
#       vmImage: 'ubuntu-latest'
#     steps:
#     - task: Bash@3
#       inputs:
#         targetType: 'inline'
#         script: |
#           sudo apt update
#           sudo apt install -y python3 python3-pip
#       displayName: "Install Python"
trigger:
- main

pool: Default   # self-hosted Windows agent

stages:
#---------------------- BACKEND BUILD ----------------------
- stage: Build
  displayName: "Build Backend"
  jobs:
  - job: Build_Backend
    displayName: "Build Backend Job"
    steps:
    #------------------------------------------
    # Check & Install Python (only if missing)
    #------------------------------------------
    - task: PowerShell@2
      displayName: "Check & Install Python"
      inputs:
        targetType: inline
        script: |
          Write-Host "Checking if Python already exists..."
          $python = Get-Command python -ErrorAction SilentlyContinue
          if ($python) {
              Write-Host "Python already installed at $($python.Source). Skipping installation."
          }
          else {
              Write-Host "Python not found. Installing Python..."

              Invoke-WebRequest -Uri https://www.python.org/ftp/python/3.10.11/python-3.10.11-amd64.exe -OutFile python.exe
              Start-Process python.exe -ArgumentList "/quiet InstallAllUsers=1 PrependPath=1" -Wait
              Write-Host "Python installation completed."              
              # Add PATH for this session
              $env:Path += ";C:\Program Files\Python310\;C:\Program Files\Python310\Scripts"
          }

          Write-Host "Final Python Path: $env:Path"

    #------------------------------------------
    # Verify Python installation
    #------------------------------------------
    - task: PowerShell@2
      displayName: Verify Python
      inputs:
        targetType: inline
        script: |
          python --version
          pip --version

    #------------------------------------------
    # Install dependencies into "package" folder
    #------------------------------------------
    - task: PowerShell@2
      displayName: Install Requirements
      inputs:
        targetType: inline
        script: |
          pip install -r PyTodoBackendMonolith/requirements.txt -t package

    #------------------------------------------
    # Publish artifact
    #------------------------------------------
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: 'PyTodoBackendMonolith'
        ArtifactName: 'backend_artifact'
#---------------------- BACKEND DEPLOY ----------------------
- stage: Deploy
  displayName: "Deploy Backend"
  dependsOn: Build
  jobs:
  - job: Deploy_Backend
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'backend_artifact'
        downloadPath: '$(Pipeline.Workspace)/backend'
      displayName: "Download Backend Artifact"    
    - task: CopyFilesOverSSH@0
      inputs:
        sshEndpoint: 'backend-ssh'
        sourceFolder: '$(Pipeline.Workspace)/backend'
        contents: '**'
        targetFolder: '/var/app/backend'
        readyTimeout: '20000'
      displayName: "Copy Backend Files to VM"
    - task: SSH@0
      inputs:
        sshEndpoint: 'backend-ssh'
        runOptions: 'inline'
        inline: |
          cd /var/app/backend/backend_artifact/PyTodoBackendMonolith 
          pip3 install -r requirements.txt
          pkill -f uvicorn || true
          nohup uvicorn app:app --host 0.0.0.0 --port 8000 &
        readyTimeout: '20000'
      displayName: "Install Dependencies & Restart Uvicorn"