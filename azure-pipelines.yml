trigger:
- main

pool:
  name: 'Default'   # Windows self-hosted agent

stages:

# ============================================================
#                     BACKEND BUILD (WINDOWS)
# ============================================================
- stage: Build
  displayName: "Build Backend"
  jobs:
  - job: Build_Backend
    displayName: "Build Backend on Windows Agent"
    steps:

    # Install Python only if not already installed
    - task: PowerShell@2
      displayName: "Install Python Only If Missing"
      inputs:
        targetType: inline
        script: |
          if (Get-Command python -ErrorAction SilentlyContinue) {
              Write-Host "Python is already installed."
              python --version
              exit 0
          }

          Write-Host "Python not found. Installing now..."

          $pythonInstaller = "python-installer.exe"
          Invoke-WebRequest -Uri "https://www.python.org/ftp/python/3.12.0/python-3.12.0-amd64.exe" -OutFile $pythonInstaller

          Start-Process ".\python-installer.exe" -ArgumentList "/quiet InstallAllUsers=1 PrependPath=1" -Wait

          Write-Host "Python successfully installed:"
          python --version


    # Install backend dependencies
    - task: PowerShell@2
      displayName: "Install Backend Dependencies"
      inputs:
        targetType: inline
        script: |
          cd PyTodoBackendMonolith
          python -m pip install -r requirements.txt --target "./package"

    # Publish artifact
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: 'PyTodoBackendMonolith'
        ArtifactName: 'backend_artifact'
        publishLocation: 'Container'



# ============================================================
#                     BACKEND DEPLOY (LINUX VM)
# ============================================================
- stage: Deploy
  displayName: "Deploy Backend"
  dependsOn: Build
  jobs:
  - job: Deploy_Backend
    displayName: "Deploy Backend to Linux VM"
    steps:

    - task: DownloadBuildArtifacts@1
      inputs:
        artifactName: 'backend_artifact'
        downloadPath: '$(Pipeline.Workspace)/backend'

    - task: CopyFilesOverSSH@0
      displayName: "Copy Backend Files"
      inputs:
        sshEndpoint: 'backend-ssh'
        sourceFolder: '$(Pipeline.Workspace)/backend'
        targetFolder: '/var/app/backend'
        overwrite: true

    - task: SSH@0
      displayName: "Restart Backend"
      inputs:
        sshEndpoint: 'backend-ssh'
        runOptions: inline
        inline: |
          cd /var/app/backend
          pip3 install -r requirements.txt
          pkill -f uvicorn || true
          nohup uvicorn app:app --host 0.0.0.0 --port 8000 &
