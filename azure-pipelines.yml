# trigger:
# - main
# pool: Default
# #---------------------- BACKEND BUILD ----------------------  
# stages:
# - stage: Build
#   displayName: "Build Backend"
#   jobs:
#   - job: Build_Backend
#     pool:
#       vmImage: 'ubuntu-latest'
#     steps:
#     - task: Bash@3
#       inputs:
#         targetType: 'inline'
#         script: |
#           sudo apt update
#           sudo apt install -y python3 python3-pip
#       displayName: "Install Python"
trigger:
- main
pool: Default
stages:
#---------------------- BACKEND BUILD ----------------------
- stage: Build
  displayName: "Build Backend"
  jobs:
  - job: Build_Backend
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.10'
        addToPath: true
        architecture: 'x64'
    - script: |
          python --version
          pip --version
    - script: |          
          pip install -r requirements.txt -t package

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: 'PyTodoBackendMonolith'
        ArtifactName: 'backend_artifact'

#---------------------- BACKEND DEPLOY ----------------------
- stage: Deploy
  displayName: "Deploy Backend"
  dependsOn: Build
  jobs:
  - job: Deploy_Backend
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'backend_artifact'
        downloadPath: '$(Pipeline.Workspace)/backend'
      displayName: "Download Backend Artifact"    
    - task: CopyFilesOverSSH@0
      inputs:
        sshEndpoint: 'backend-ssh'
        sourceFolder: '$(Pipeline.Workspace)/backend'
        contents: '**'
        targetFolder: '/var/app/backend'
        readyTimeout: '20000'
      displayName: "Copy Backend Files to VM"
    - task: SSH@0
      inputs:
        sshEndpoint: 'backend-ssh'
        runOptions: 'inline'
        inline: |
          cd /var/app/backend/backend_artifact/PyTodoBackendMonolith 
          pip3 install -r requirements.txt
          pkill -f uvicorn || true
          nohup uvicorn app:app --host 0.0.0.0 --port 8000 &
        readyTimeout: '20000'
      displayName: "Install Dependencies & Restart Uvicorn"